<script type="text/javascript" data-script="x-embed-loader">
  (function () {
    const targets = Array.from(document.querySelectorAll('[x-post]'));
    if (!targets.length) return;

    const extractUrl = (el) =>
      (el.dataset && el.dataset.xUrl) ||
      (el.querySelector('a[href]') && el.querySelector('a[href]').href) ||
      (el.textContent || '').trim();

    const extractTweetId = (url) => {
      const match = /status\/(\d+)/.exec(url || '');
      return match ? match[1] : null;
    };

    const render = (twttr) =>
      targets.forEach((el) => {
        const url = extractUrl(el);
        const id = extractTweetId(url);
        if (!id) return;
        const host = document.createElement('div');
        host.className = 'x-embed';
        el.replaceWith(host);
        twttr.widgets.createTweet(id, host, {
          align: 'center',
          theme: 'dark',
          dnt: true,
        });
      });

    const ready = (resolve) => {
      if (window.twttr && window.twttr.ready) {
        return window.twttr.ready(resolve);
      }
      if (window.twttr && window.twttr.widgets) {
        return resolve(window.twttr);
      }
      setTimeout(() => ready(resolve), 50);
    };

    const loadTwitter = () =>
      new Promise((resolve) => {
        if (!document.getElementById('twitter-wjs')) {
          const script = document.createElement('script');
          script.id = 'twitter-wjs';
          script.src = 'https://platform.twitter.com/widgets.js';
          script.async = true;
          document.body.appendChild(script);
        }
        ready(resolve);
      });

    loadTwitter().then(render);
  })();
</script>
